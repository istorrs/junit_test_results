<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="console-capture.js"></script>
        <title>Reports - JUnit Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="shared-styles.css" />
        <style>
            body {
                font-family: 'Inter', sans-serif;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                min-height: 100vh;
            }

            .code-font {
                font-family: 'JetBrains Mono', monospace;
            }

            .report-card {
                transition: all 0.3s ease;
                border-left: 4px solid transparent;
            }

            .report-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
                border-left-color: #3b82f6;
            }

            .nav-link {
                position: relative;
                transition: all 0.3s ease;
            }

            .nav-link:hover {
                color: #3b82f6;
            }

            .nav-link.active::after {
                content: '';
                position: absolute;
                bottom: -2px;
                left: 0;
                right: 0;
                height: 2px;
                background: #3b82f6;
                border-radius: 1px;
            }

            .report-builder {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            }

            /* Dark mode for report builder */
            .dark .report-builder {
                background: rgba(31, 41, 55, 0.95);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }

            .template-card {
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .template-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            }

            .dark .template-card:hover {
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            }

            .template-card.selected {
                border-color: #3b82f6;
                background: rgba(59, 130, 246, 0.05);
            }

            .dark .template-card.selected {
                background: rgba(59, 130, 246, 0.15);
            }

            .export-format {
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .export-format:hover {
                background: rgba(59, 130, 246, 0.05);
            }

            .dark .export-format:hover {
                background: rgba(59, 130, 246, 0.15);
            }

            .export-format.selected {
                background: rgba(59, 130, 246, 0.1);
                border-color: #3b82f6;
            }

            .dark .export-format.selected {
                background: rgba(59, 130, 246, 0.2);
            }

            .preview-container {
                background: #1a1a1a;
                color: #e5e5e5;
                border-radius: 8px;
                padding: 16px;
                font-family: 'JetBrains Mono', monospace;
                font-size: 14px;
                line-height: 1.5;
                overflow-x: auto;
                max-height: 400px;
                overflow-y: auto;
            }

            /* Light mode preview */
            :not(.dark) .preview-container {
                background: #f9fafb;
                color: #1f2937;
                border: 1px solid #e5e7eb;
            }
        </style>
    </head>
    <body>
        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40"></nav>

        <!-- Header -->
        <div class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Reports & Export</h1>
                        <p class="text-gray-600 mt-1">
                            Generate comprehensive reports and export your test results
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button
                            id="generate-report"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200"
                        >
                            Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Report Builder -->
                <div class="lg:col-span-2">
                    <div class="report-builder p-6 mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Report Builder</h3>

                        <!-- Report Templates -->
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">Report Templates</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div
                                    class="template-card border-2 border-gray-200 rounded-lg p-4 selected"
                                    data-template="summary"
                                >
                                    <div class="flex items-center mb-2">
                                        <svg
                                            class="w-5 h-5 text-blue-600 mr-2"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                                            />
                                        </svg>
                                        <h5 class="font-medium text-gray-900">Summary Report</h5>
                                    </div>
                                    <p class="text-sm text-gray-600">
                                        High-level overview of test results and key metrics
                                    </p>
                                </div>
                                <div
                                    class="template-card border-2 border-gray-200 rounded-lg p-4"
                                    data-template="detailed"
                                >
                                    <div class="flex items-center mb-2">
                                        <svg
                                            class="w-5 h-5 text-gray-400 mr-2"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                            />
                                        </svg>
                                        <h5 class="font-medium text-gray-900">Detailed Report</h5>
                                    </div>
                                    <p class="text-sm text-gray-600">
                                        Comprehensive analysis with test case details
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Export Formats -->
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">Export Format</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div
                                    class="export-format border-2 border-gray-200 rounded-lg p-3 text-center selected"
                                    data-format="json"
                                >
                                    <svg
                                        class="w-6 h-6 mx-auto mb-2 text-blue-600"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                                        />
                                    </svg>
                                    <span class="text-sm font-medium">JSON</span>
                                </div>
                                <div
                                    class="export-format border-2 border-gray-200 rounded-lg p-3 text-center"
                                    data-format="csv"
                                >
                                    <svg
                                        class="w-6 h-6 mx-auto mb-2 text-green-600"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                        />
                                    </svg>
                                    <span class="text-sm font-medium">CSV</span>
                                </div>
                                <div
                                    class="export-format border-2 border-gray-200 rounded-lg p-3 text-center"
                                    data-format="html"
                                >
                                    <svg
                                        class="w-6 h-6 mx-auto mb-2 text-orange-600"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"
                                        />
                                    </svg>
                                    <span class="text-sm font-medium">HTML</span>
                                </div>
                                <div
                                    class="export-format border-2 border-gray-200 rounded-lg p-3 text-center"
                                    data-format="pdf"
                                >
                                    <svg
                                        class="w-6 h-6 mx-auto mb-2 text-red-600"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                        />
                                    </svg>
                                    <span class="text-sm font-medium">PDF</span>
                                </div>
                            </div>
                        </div>

                        <!-- Data Selection -->
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">
                                Include in Report
                            </h4>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input
                                        type="checkbox"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        checked
                                    />
                                    <span class="ml-2 text-sm text-gray-700">Test run summary</span>
                                </label>
                                <label class="flex items-center">
                                    <input
                                        type="checkbox"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        checked
                                    />
                                    <span class="ml-2 text-sm text-gray-700"
                                        >Test suite breakdown</span
                                    >
                                </label>
                                <label class="flex items-center">
                                    <input
                                        type="checkbox"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        checked
                                    />
                                    <span class="ml-2 text-sm text-gray-700"
                                        >Failed test details</span
                                    >
                                </label>
                                <label class="flex items-center">
                                    <input
                                        type="checkbox"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    />
                                    <span class="ml-2 text-sm text-gray-700"
                                        >Performance metrics</span
                                    >
                                </label>
                                <label class="flex items-center">
                                    <input
                                        type="checkbox"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    />
                                    <span class="ml-2 text-sm text-gray-700"
                                        >System information</span
                                    >
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div class="report-builder p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Preview</h3>
                        <div class="preview-container" id="report-preview">
                            <!-- Preview content will be populated here -->
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <button
                                id="update-preview"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors duration-200"
                            >
                                Update Preview
                            </button>
                            <button
                                id="download-report"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200"
                            >
                                Download Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <!-- Recent Reports -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">Recent Reports</h3>
                        </div>
                        <div class="p-6">
                            <div id="recent-reports" class="space-y-4">
                                <!-- Recent reports will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">Quick Stats</h3>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Total Reports</span>
                                    <span
                                        class="text-lg font-semibold text-gray-900"
                                        id="total-reports"
                                        >0</span
                                    >
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">This Week</span>
                                    <span
                                        class="text-lg font-semibold text-blue-600"
                                        id="reports-this-week"
                                        >0</span
                                    >
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Most Used Format</span>
                                    <span
                                        class="text-sm font-medium text-gray-900"
                                        id="most-used-format"
                                        >JSON</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 mt-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="text-center text-gray-600">
                    <p>
                        &copy; 2025 JUnit Test Results Dashboard. Built with modern web
                        technologies.
                    </p>
                </div>
            </div>
        </footer>

        <!-- Load Scripts -->
        <script src="theme.js"></script>
        <script src="navigation.js"></script>
        <script src="api-client.js"></script>
        <script>
            class ReportsPage {
                constructor() {
                    this.db = new JUnitDatabase();
                    this.selectedTemplate = 'summary';
                    this.selectedFormat = 'json';
                    this.reports = [];
                    this.init();
                }

                async init() {
                    try {
                        await this.db.initializeDatabase();
                        this.setupEventListeners();
                        this.loadReports();
                        this.updatePreview();
                    } catch (error) {
                        console.error('Failed to initialize reports page:', error);
                    }
                }

                setupEventListeners() {
                    // Template selection
                    document.querySelectorAll('.template-card').forEach(card => {
                        card.addEventListener('click', this.selectTemplate.bind(this));
                    });

                    // Format selection
                    document.querySelectorAll('.export-format').forEach(format => {
                        format.addEventListener('click', this.selectFormat.bind(this));
                    });

                    // Generate report
                    document
                        .getElementById('generate-report')
                        .addEventListener('click', this.generateReport.bind(this));
                    document
                        .getElementById('update-preview')
                        .addEventListener('click', this.updatePreview.bind(this));
                    document
                        .getElementById('download-report')
                        .addEventListener('click', this.downloadReport.bind(this));
                }

                selectTemplate(event) {
                    document.querySelectorAll('.template-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    event.currentTarget.classList.add('selected');
                    this.selectedTemplate = event.currentTarget.dataset.template;
                    this.updatePreview();
                }

                selectFormat(event) {
                    document.querySelectorAll('.export-format').forEach(format => {
                        format.classList.remove('selected');
                    });
                    event.currentTarget.classList.add('selected');
                    this.selectedFormat = event.currentTarget.dataset.format;
                    this.updatePreview();
                }

                async loadReports() {
                    // Mock recent reports - in real implementation, this would come from database
                    this.reports = [
                        {
                            id: 1,
                            name: 'Weekly Test Summary',
                            format: 'json',
                            date: new Date(Date.now() - 86400000).toISOString(),
                            size: '2.3 MB'
                        },
                        {
                            id: 2,
                            name: 'Release Test Report',
                            format: 'html',
                            date: new Date(Date.now() - 172800000).toISOString(),
                            size: '1.8 MB'
                        },
                        {
                            id: 3,
                            name: 'Performance Analysis',
                            format: 'csv',
                            date: new Date(Date.now() - 259200000).toISOString(),
                            size: '890 KB'
                        }
                    ];

                    this.renderRecentReports();
                    this.updateQuickStats();
                }

                renderRecentReports() {
                    const container = document.getElementById('recent-reports');
                    if (!container) return;

                    container.innerHTML = this.reports
                        .map(
                            report => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <h5 class="text-sm font-medium text-gray-900">${report.name}</h5>
                            <p class="text-xs text-gray-600">${new Date(report.date).toLocaleDateString()} â€¢ ${report.size}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 uppercase">
                                ${report.format}
                            </span>
                            <button class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                                Download
                            </button>
                        </div>
                    </div>
                `
                        )
                        .join('');
                }

                updateQuickStats() {
                    document.getElementById('total-reports').textContent = this.reports.length;
                    document.getElementById('reports-this-week').textContent = '3';

                    const formatCounts = {};
                    this.reports.forEach(report => {
                        formatCounts[report.format] = (formatCounts[report.format] || 0) + 1;
                    });

                    const mostUsed = Object.keys(formatCounts).reduce((a, b) =>
                        formatCounts[a] > formatCounts[b] ? a : b
                    );
                    document.getElementById('most-used-format').textContent =
                        mostUsed.toUpperCase();
                }

                async updatePreview() {
                    const preview = document.getElementById('report-preview');
                    if (!preview) return;

                    try {
                        const stats = await this.db.getTestStatistics();
                        const testRuns = await this.db.getTestRuns(5);

                        let previewContent = '';

                        if (this.selectedFormat === 'json') {
                            const reportData = {
                                template: this.selectedTemplate,
                                generatedAt: new Date().toISOString(),
                                summary: {
                                    totalTests: stats.total,
                                    passed: stats.passed,
                                    failed: stats.failed,
                                    errors: stats.error,
                                    skipped: stats.skipped,
                                    totalTime: stats.total_time
                                },
                                recentRuns: testRuns.map(run => ({
                                    name: run.name,
                                    timestamp: run.timestamp,
                                    tests: run.total_tests,
                                    failures: run.total_failures,
                                    time: run.time
                                }))
                            };

                            previewContent = JSON.stringify(reportData, null, 2);
                        } else if (this.selectedFormat === 'csv') {
                            previewContent =
                                'Template,Generated At,Total Tests,Passed,Failed,Errors,Skipped,Total Time\n';
                            previewContent += `${this.selectedTemplate},${new Date().toISOString()},${stats.total},${stats.passed},${stats.failed},${stats.error},${stats.skipped},${stats.total_time}`;
                        } else if (this.selectedFormat === 'html') {
                            previewContent = `<!DOCTYPE html>
<html>
<head>
    <title>JUnit Test Report</title>
</head>
<body>
    <h1>JUnit Test Report - ${this.selectedTemplate}</h1>
    <p>Generated: ${new Date().toISOString()}</p>
    
    <h2>Summary</h2>
    <ul>
        <li>Total Tests: ${stats.total}</li>
        <li>Passed: ${stats.passed}</li>
        <li>Failed: ${stats.failed}</li>
        <li>Errors: ${stats.error}</li>
        <li>Skipped: ${stats.skipped}</li>
        <li>Total Time: ${stats.total_time.toFixed(2)}s</li>
    </ul>
</body>
</html>`;
                        }

                        preview.textContent = previewContent;
                    } catch (error) {
                        console.error('Error updating preview:', error);
                        preview.textContent = 'Error generating preview. Please try again.';
                    }
                }

                async generateReport() {
                    const button = document.getElementById('generate-report');
                    const originalText = button.textContent;

                    button.textContent = 'Generating...';
                    button.disabled = true;

                    try {
                        await this.updatePreview();

                        // Add to recent reports
                        const newReport = {
                            id: this.reports.length + 1,
                            name: `${this.selectedTemplate} Report`,
                            format: this.selectedFormat,
                            date: new Date().toISOString(),
                            size: '1.2 MB'
                        };

                        this.reports.unshift(newReport);
                        this.renderRecentReports();
                        this.updateQuickStats();

                        this.showNotification('Report generated successfully!', 'success');
                    } catch (error) {
                        console.error('Error generating report:', error);
                        this.showNotification('Error generating report', 'error');
                    } finally {
                        button.textContent = originalText;
                        button.disabled = false;
                    }
                }

                downloadReport() {
                    const preview = document.getElementById('report-preview');
                    if (!preview || !preview.textContent) {
                        this.showNotification('No report to download', 'error');
                        return;
                    }

                    let content = preview.textContent;
                    let mimeType = 'text/plain';
                    let filename = `test-report.${this.selectedFormat}`;

                    if (this.selectedFormat === 'json') {
                        mimeType = 'application/json';
                    } else if (this.selectedFormat === 'csv') {
                        mimeType = 'text/csv';
                    } else if (this.selectedFormat === 'html') {
                        mimeType = 'text/html';
                    }

                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);

                    this.showNotification('Report downloaded successfully!', 'success');
                }

                showNotification(message, type) {
                    const notification = document.createElement('div');
                    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                        type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
                    }`;
                    notification.textContent = message;

                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 5000);
                }
            }

            // Initialize reports page
            document.addEventListener('DOMContentLoaded', () => {
                window.reportsPage = new ReportsPage();
            });
        </script>
    </body>
</html>
