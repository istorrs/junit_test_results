#!/bin/bash
#
# Pre-commit hook to prevent committing TypeScript code with compilation errors
#

echo "Running pre-commit checks..."

# Check if there are changes in the client directory
if git diff --cached --name-only | grep -q "^client/"; then
    echo "Detected changes in client directory. Running TypeScript type check..."

    # Navigate to client directory and run type check
    cd client || exit 1

    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo "❌ Error: node_modules not found in client directory."
        echo "Installing dependencies automatically..."

        # Try to install dependencies
        if npm install 2>&1; then
            echo "✅ Dependencies installed successfully!"
        else
            echo ""
            echo "❌ Failed to install dependencies!"
            echo "Please run 'cd client && npm install' manually before committing."
            exit 1
        fi
    fi

    # Run TypeScript type check
    if ! npm run type-check 2>&1; then
        echo ""
        echo "❌ TypeScript compilation errors detected!"
        echo "Please fix the TypeScript errors before committing."
        echo "Run 'cd client && npm run type-check' to see the errors."
        exit 1
    fi

    echo "✅ TypeScript type check passed!"

    # Run security audit
    echo "Running security audit..."
    if ! npm audit --audit-level=moderate 2>&1; then
        echo ""
        echo "❌ Security vulnerabilities detected!"
        echo "Please fix the vulnerabilities before committing."
        echo "Run 'cd client && npm audit' to see details."
        echo "Run 'cd client && npm audit fix' to attempt automatic fixes."
        exit 1
    fi

    echo "✅ Security audit passed!"
    cd ..
fi

# Check if there are changes in the backend directory
if git diff --cached --name-only | grep -q "^backend/"; then
    echo "Detected changes in backend directory. Running backend checks..."

    cd backend || exit 1

    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo "❌ Error: node_modules not found in backend directory."
        echo "Installing dependencies automatically..."

        # Try to install dependencies
        if npm install 2>&1; then
            echo "✅ Dependencies installed successfully!"
        else
            echo ""
            echo "❌ Failed to install dependencies!"
            echo "Please run 'cd backend && npm install' manually before committing."
            exit 1
        fi
    fi

    # Check if lint script exists
    if npm run | grep -q "lint$"; then
        # Run ESLint check
        if ! npm run lint 2>&1; then
            echo ""
            echo "❌ Backend linting errors detected!"
            echo "Please fix the errors before committing."
            echo "Run 'cd backend && npm run lint' to see the errors."
            echo "Or run 'cd backend && npm run lint:fix' to auto-fix some issues."
            exit 1
        fi
        echo "✅ Backend lint check passed!"
    else
        echo "⚠️  No lint script found in backend, skipping lint check"
    fi

    # Run security audit
    echo "Running security audit..."
    if ! npm audit --audit-level=moderate 2>&1; then
        echo ""
        echo "❌ Security vulnerabilities detected!"
        echo "Please fix the vulnerabilities before committing."
        echo "Run 'cd backend && npm audit' to see details."
        echo "Run 'cd backend && npm audit fix' to attempt automatic fixes."
        exit 1
    fi

    echo "✅ Security audit passed!"
    cd ..
fi

echo "✅ All pre-commit checks passed!"
exit 0
