<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="error-boundary.js"></script>
        <script src="console-capture.js"></script>
        <title>Test Details - JUnit Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class'
            };
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="shared-styles.css" />
        <script src="global-search.js" defer></script>
        <style>
            body {
                font-family: 'Inter', sans-serif;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                min-height: 100vh;
            }

            .code-font {
                font-family: 'JetBrains Mono', monospace;
            }

            .test-case-card {
                transition: all 0.3s ease;
                border-left: 4px solid transparent;
            }

            .test-case-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            }

            .test-case-card.passed {
                border-left-color: #10b981;
            }

            .test-case-card.failed {
                border-left-color: #ef4444;
            }

            .test-case-card.error {
                border-left-color: #f59e0b;
            }

            .test-case-card.skipped {
                border-left-color: #6b7280;
            }

            .stack-trace {
                background: #1a1a1a;
                color: #e5e5e5;
                border-radius: 8px;
                padding: 16px;
                font-family: 'JetBrains Mono', monospace;
                font-size: 14px;
                line-height: 1.5;
                overflow-x: auto;
            }

            .performance-chart {
                backdrop-filter: blur(10px);
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            }

            .nav-link {
                position: relative;
                transition: all 0.3s ease;
            }

            .nav-link:hover {
                color: #3b82f6;
            }

            .nav-link.active::after {
                content: '';
                position: absolute;
                bottom: -2px;
                left: 0;
                right: 0;
                height: 2px;
                background: #3b82f6;
                border-radius: 1px;
            }

            .expandable-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .expandable-content.expanded {
                max-height: 1000px;
            }

            .status-badge {
                display: inline-flex;
                align-items: center;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .status-badge.passed {
                background: #dcfce7;
                color: #166534;
            }

            .status-badge.failed {
                background: #fee2e2;
                color: #991b1b;
            }

            .status-badge.error {
                background: #fef3c7;
                color: #92400e;
            }

            .status-badge.skipped {
                background: #f3f4f6;
                color: #374151;
            }

            .metric-card {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                transition: all 0.3s ease;
            }

            .metric-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }
        </style>
    </head>
    <body>
        <!-- Navigation (populated by navigation.js) -->
        <nav
            class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40"
        ></nav>

        <!-- Header -->
        <div class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Test Run Details</h1>
                        <p class="text-gray-600 mt-1" id="run-info">
                            Loading test run information...
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button
                            id="export-btn"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200"
                        >
                            Export Results
                        </button>
                        <button
                            onclick="history.back()"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors duration-200"
                        >
                            ‚Üê Back
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Warning Banner (hidden by default, shown when limit is hit) -->
            <div
                id="limit-warning-banner"
                class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-lg"
                style="display: none"
            >
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg
                            class="h-6 w-6 text-red-500"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                            />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-sm font-medium text-red-800">System Limit Reached</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p id="limit-warning-message">
                                Only a subset of test cases could be loaded. Some tests may not be
                                visible when expanding test suites.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                <div class="metric-card rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-gray-900 mb-1" id="total-tests-summary">
                        -
                    </div>
                    <div class="text-sm text-gray-600">Total Tests</div>
                </div>
                <div class="metric-card rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-green-600 mb-1" id="passed-tests-summary">
                        -
                    </div>
                    <div class="text-sm text-gray-600">Passed</div>
                </div>
                <div class="metric-card rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-red-600 mb-1" id="failed-tests-summary">
                        -
                    </div>
                    <div class="text-sm text-gray-600">Failed</div>
                </div>
                <div class="metric-card rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-1" id="total-time-summary">
                        -
                    </div>
                    <div class="text-sm text-gray-600">Total Time</div>
                </div>
            </div>

            <!-- Performance Chart -->
            <div class="performance-chart p-6 mb-8 bg-white/95 dark:bg-gray-800/95">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Test Execution Performance</h3>
                <div id="performance-chart" style="height: 300px"></div>
            </div>

            <!-- Failure Patterns Analysis -->
            <div
                id="failure-patterns-section"
                class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8"
                style="display: none"
            >
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Failure Patterns</h3>
                </div>
                <div class="p-6">
                    <!-- Pattern Summary -->
                    <div id="pattern-summary" class="mb-6">
                        <!-- Summary will be populated here -->
                    </div>

                    <!-- Patterns List -->
                    <div id="patterns-container">
                        <!-- Patterns will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Test Suites & Cases (Tree View) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Test Suites & Cases</h3>
                        <button
                            id="toggle-all-suites"
                            class="flex items-center space-x-1 px-3 py-1.5 text-sm font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-colors"
                        >
                            <svg id="toggle-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                            <span id="toggle-text">Expand All</span>
                        </button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select
                            id="suite-filter"
                            class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="all">All Suites</option>
                        </select>
                        <select
                            id="status-filter"
                            class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="all">All Status</option>
                            <option value="passed">Passed</option>
                            <option value="failed">Failed</option>
                            <option value="error">Error</option>
                            <option value="skipped">Skipped</option>
                        </select>
                        <input
                            type="text"
                            id="test-search"
                            placeholder="Search tests..."
                            class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                </div>
                <div id="test-suites-tree-container">
                    <!-- Test suites tree will be populated here -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 mt-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="text-center text-gray-600">
                    <p>
                        &copy; 2025 JUnit Test Results Dashboard. Built with modern web
                        technologies.
                    </p>
                </div>
            </div>
        </footer>

        <!-- Load Scripts -->
        <script src="theme.js"></script>
        <script src="navigation.js"></script>
        <script src="limits-config.js"></script>
        <script src="api-client.js"></script>
        <script src="debug.js"></script>
        <script src="shared-utils.js"></script>
        <script src="test-details-modal.js"></script>
        <script>
            class TestDetailsPage {
                constructor() {
                    console.log('[TestDetailsPage] Constructor started');
                    this.db = new JUnitAPIClient();
                    console.log('[TestDetailsPage] JUnitAPIClient initialized:', this.db);
                    this.runId = null;
                    this.testSuites = [];
                    this.testCases = [];
                    this.allSuitesExpanded = false;
                    console.log('[TestDetailsPage] Calling init()');
                    this.init();
                }

                async init() {
                    console.log('[TestDetailsPage.init] Starting initialization');
                    try {
                        this.runId = this.getRunIdFromUrl();
                        console.log('[TestDetailsPage.init] Run ID from URL:', this.runId);

                        if (this.runId) {
                            console.log(
                                '[TestDetailsPage.init] Loading test run details for ID:',
                                this.runId
                            );
                            await this.loadTestRunDetails();
                            console.log(
                                '[TestDetailsPage.init] Test run details loaded successfully'
                            );
                        } else {
                            console.warn('[TestDetailsPage.init] No run ID in URL');
                            this.showError('No test run specified');
                        }

                        console.log('[TestDetailsPage.init] Setting up event listeners');
                        this.setupEventListeners();
                        console.log('[TestDetailsPage.init] Initialization complete');
                    } catch (error) {
                        logError('Failed to initialize Test Details page', error);
                        this.showError('Failed to load test details');
                    }
                }

                getRunIdFromUrl() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const runId = urlParams.get('run') || null;
                    console.log(
                        '[TestDetailsPage.getRunIdFromUrl] URL search params:',
                        window.location.search
                    );
                    console.log('[TestDetailsPage.getRunIdFromUrl] Extracted run ID:', runId);
                    return runId;
                }

                async loadTestRunDetails() {
                    console.log(
                        '[TestDetailsPage.loadTestRunDetails] Starting to load test run details'
                    );
                    console.log('[TestDetailsPage.loadTestRunDetails] Run ID:', this.runId);

                    try {
                        console.log(
                            '[TestDetailsPage.loadTestRunDetails] Fetching data from API...'
                        );
                        const [testRun, testSuites, testCases, statistics] = await Promise.all([
                            this.getTestRun(this.runId),
                            this.db.getTestSuites(this.runId),
                            this.db.getTestCases({ run_id: this.runId, limit: 1000 }),
                            this.db.getTestStatistics(this.runId)
                        ]);

                        console.log('[TestDetailsPage.loadTestRunDetails] API responses received:');
                        console.log('  - testRun:', testRun);
                        console.log('  - testSuites count:', testSuites?.length || 0);
                        console.log('  - testCases count:', testCases?.length || 0);
                        console.log('  - statistics:', statistics);

                        // Check if we hit the limit and warn loudly
                        const LIMIT = 1000;
                        if (testCases && testCases.length >= LIMIT) {
                            const errorMsg = `‚ö†Ô∏è CRITICAL WARNING: Test case limit (${LIMIT}) reached! Only ${testCases.length} out of ${statistics.total} total tests loaded. Some test cases may not be visible. This is a system limitation that needs to be addressed.`;
                            console.error(errorMsg);
                            logError(errorMsg, {
                                loadedCount: testCases.length,
                                totalCount: statistics.total,
                                limit: LIMIT,
                                runId: this.runId
                            });

                            // Show visual warning banner
                            const warningBanner = document.getElementById('limit-warning-banner');
                            const warningMessage = document.getElementById('limit-warning-message');
                            if (warningBanner && warningMessage) {
                                warningMessage.textContent = `‚ö†Ô∏è CRITICAL: Only ${testCases.length} out of ${statistics.total} total tests could be loaded due to system limit (${LIMIT}). Some test cases will not be visible when expanding test suites. This issue must be addressed.`;
                                warningBanner.style.display = 'block';
                            }

                            // Also show alert
                            alert(
                                `‚ö†Ô∏è WARNING: Only ${testCases.length} out of ${statistics.total} tests could be loaded due to system limits. Some tests may not be visible in suite expansions.`
                            );
                        }

                        // Log if we're getting close to the limit (>80%)
                        if (
                            testCases &&
                            testCases.length > LIMIT * 0.8 &&
                            testCases.length < LIMIT
                        ) {
                            console.warn(
                                `‚ö†Ô∏è WARNING: Approaching test case limit. Loaded ${testCases.length} out of ${LIMIT} maximum. Total tests in run: ${statistics.total}`
                            );
                        }

                        this.testSuites = testSuites;
                        this.testCases = testCases;

                        console.log(
                            '[TestDetailsPage.loadTestRunDetails] Updating UI components...'
                        );
                        this.updateRunInfo(testRun);
                        console.log('[TestDetailsPage.loadTestRunDetails] - Run info updated');

                        this.updateSummaryCards(statistics);
                        console.log('[TestDetailsPage.loadTestRunDetails] - Summary cards updated');

                        this.renderSuitesTree();
                        console.log('[TestDetailsPage.loadTestRunDetails] - Test suites tree rendered');

                        this.initializePerformanceChart();
                        console.log(
                            '[TestDetailsPage.loadTestRunDetails] - Performance chart initialized'
                        );

                        this.renderFailurePatterns();
                        console.log(
                            '[TestDetailsPage.loadTestRunDetails] - Failure patterns rendered'
                        );

                        console.log(
                            '[TestDetailsPage.loadTestRunDetails] All data loaded and rendered successfully'
                        );
                    } catch (error) {
                        logError('Failed to load test run details from API', error);
                        throw error;
                    }
                }

                async getTestRun(runId) {
                    console.log('[TestDetailsPage.getTestRun] Fetching test run:', runId);
                    const response = await this.db.getTestRun(runId);
                    console.log('[TestDetailsPage.getTestRun] Response:', response);
                    return response.run;
                }

                updateRunInfo(testRun) {
                    console.log('[TestDetailsPage.updateRunInfo] Updating run info with:', testRun);
                    const runInfoElement = document.getElementById('run-info');
                    console.log(
                        '[TestDetailsPage.updateRunInfo] Run info element:',
                        runInfoElement
                    );

                    if (runInfoElement && testRun) {
                        const date = new Date(testRun.timestamp).toLocaleString();
                        const text = `${testRun.name} ‚Ä¢ ${date} ‚Ä¢ ${testRun.total_tests} tests`;
                        runInfoElement.textContent = text;
                        console.log('[TestDetailsPage.updateRunInfo] Set text to:', text);
                    } else {
                        console.warn('[TestDetailsPage.updateRunInfo] Element or data missing');
                    }
                }

                updateSummaryCards(stats) {
                    console.log(
                        '[TestDetailsPage.updateSummaryCards] Updating summary cards with:',
                        stats
                    );
                    const elements = {
                        total: document.getElementById('total-tests-summary'),
                        passed: document.getElementById('passed-tests-summary'),
                        failed: document.getElementById('failed-tests-summary'),
                        time: document.getElementById('total-time-summary')
                    };

                    console.log('[TestDetailsPage.updateSummaryCards] Elements found:', {
                        total: !!elements.total,
                        passed: !!elements.passed,
                        failed: !!elements.failed,
                        time: !!elements.time
                    });

                    if (elements.total) {
                        elements.total.textContent = stats.total;
                        console.log(
                            '[TestDetailsPage.updateSummaryCards] Total set to:',
                            stats.total
                        );
                    }
                    if (elements.passed) {
                        elements.passed.textContent = stats.passed;
                        console.log(
                            '[TestDetailsPage.updateSummaryCards] Passed set to:',
                            stats.passed
                        );
                    }
                    if (elements.failed) {
                        const failedCount = stats.failed + stats.error;
                        elements.failed.textContent = failedCount;
                        console.log(
                            '[TestDetailsPage.updateSummaryCards] Failed set to:',
                            failedCount
                        );
                    }
                    if (elements.time) {
                        const timeText = `${stats.total_time.toFixed(2)}s`;
                        elements.time.textContent = timeText;
                        console.log('[TestDetailsPage.updateSummaryCards] Time set to:', timeText);
                    }
                }

                renderSuitesTree() {
                    console.log('[TestDetailsPage.renderSuitesTree] Starting to render suites tree');
                    console.log('[TestDetailsPage.renderSuitesTree] Number of suites:', this.testSuites.length);
                    console.log('[TestDetailsPage.renderSuitesTree] Number of test cases:', this.testCases.length);

                    const container = document.getElementById('test-suites-tree-container');
                    const filter = document.getElementById('suite-filter');

                    if (!container) {
                        console.warn('[TestDetailsPage.renderSuitesTree] Container not found, aborting');
                        return;
                    }

                    // Populate suite filter dropdown
                    if (filter) {
                        filter.innerHTML = '<option value="all">All Suites</option>';
                        this.testSuites.forEach(suite => {
                            const option = document.createElement('option');
                            option.value = suite.id;
                            option.textContent = suite.name;
                            filter.appendChild(option);
                        });
                    }

                    // Group test cases by suite_id
                    const testsBySuite = {};
                    this.testCases.forEach(testCase => {
                        if (!testsBySuite[testCase.suite_id]) {
                            testsBySuite[testCase.suite_id] = [];
                        }
                        testsBySuite[testCase.suite_id].push(testCase);
                    });

                    // Render tree: suites with their test cases underneath
                    container.innerHTML = this.testSuites
                        .map(suite => {
                            const suiteTests = testsBySuite[suite.id] || [];
                            const passedCount = suiteTests.filter(t => t.status === 'passed').length;
                            const failedCount = suiteTests.filter(t => t.status === 'failed').length;
                            const errorCount = suiteTests.filter(t => t.status === 'error').length;
                            const skippedCount = suiteTests.filter(t => t.status === 'skipped').length;

                            return `
                                <div class="suite-tree-item border-b border-gray-200" data-suite-id="${suite.id}">
                                    <!-- Suite Header -->
                                    <div class="px-6 py-4 cursor-pointer hover:bg-gray-50" onclick="detailsPage.toggleSuite('${suite.id}')">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-3">
                                                <svg class="w-5 h-5 text-gray-400 transform transition-transform" id="suite-arrow-${suite.id}">
                                                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                </svg>
                                                <div>
                                                    <h4 class="text-base font-semibold text-gray-900">${suite.name}</h4>
                                                    <p class="text-sm text-gray-600">${suite.tests} tests ‚Ä¢ ${suite.time.toFixed(2)}s</p>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                ${passedCount > 0 ? `<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">${passedCount} passed</span>` : ''}
                                                ${failedCount > 0 ? `<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">${failedCount} failed</span>` : ''}
                                                ${errorCount > 0 ? `<span class="px-2 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-800">${errorCount} errors</span>` : ''}
                                                ${skippedCount > 0 ? `<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">${skippedCount} skipped</span>` : ''}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Suite Test Cases (Collapsible) -->
                                    <div class="expandable-content" id="suite-content-${suite.id}">
                                        <div class="bg-gray-50 px-6 py-4 space-y-3">
                                            ${suiteTests.map(testCase => `
                                                <div class="test-case-card ${testCase.status} bg-white p-4 rounded border border-gray-200" data-test-case-id="${testCase.id}">
                                                    <div class="flex items-start justify-between mb-2">
                                                        <div class="flex-1">
                                                            <h5 class="text-sm font-medium text-gray-900 mb-1">${testCase.name}</h5>
                                                            <p class="text-xs text-gray-600">${testCase.classname}</p>
                                                        </div>
                                                        <div class="text-right">
                                                            <div class="text-sm font-medium text-gray-900">${testCase.time.toFixed(3)}s</div>
                                                            <div class="text-xs text-gray-600">${testCase.assertions || 0} assertions</div>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center justify-between">
                                                        <div class="flex items-center space-x-2">
                                                            <span class="status-badge ${testCase.status}">${testCase.status}</span>
                                                            ${testCase.is_flaky ? '<span class="status-badge bg-yellow-100 text-yellow-800">‚ö†Ô∏è FLAKY</span>' : ''}
                                                        </div>
                                                        <div class="flex gap-2">
                                                            <button class="text-green-600 hover:text-green-800 text-xs font-medium" onclick="detailsPage.viewTestHistory('${testCase.name.replace(/'/g, "\\'")}', '${testCase.classname.replace(/'/g, "\\'")}')">
                                                                üìä History
                                                            </button>
                                                            <button class="text-blue-600 hover:text-blue-800 text-xs font-medium" onclick="detailsPage.viewTestDetails('${testCase.id}')">
                                                                Details ‚Üí
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        })
                        .join('');

                    console.log('[TestDetailsPage.renderSuitesTree] Tree rendered successfully');
                }

                initializePerformanceChart() {
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Starting chart initialization'
                    );
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Number of test cases available:',
                        this.testCases.length
                    );

                    const chartContainer = document.getElementById('performance-chart');
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Chart container element:',
                        chartContainer
                    );

                    if (!chartContainer) {
                        console.warn(
                            '[TestDetailsPage.initializePerformanceChart] Chart container not found, aborting'
                        );
                        return;
                    }

                    // Get current theme by checking if dark class is present on html element
                    const isDark = document.documentElement.classList.contains('dark');
                    console.log('[TestDetailsPage.initializePerformanceChart] Dark mode:', isDark);

                    // Dispose existing chart if it exists
                    if (this.performanceChart) {
                        console.log(
                            '[TestDetailsPage.initializePerformanceChart] Disposing existing chart'
                        );
                        this.performanceChart.dispose();
                    }

                    // Initialize chart with theme-aware colors
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Initializing ECharts instance'
                    );
                    this.performanceChart = echarts.init(chartContainer);
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] ECharts instance created:',
                        this.performanceChart
                    );

                    // Prepare data - sort by execution time descending to show slowest tests first
                    const sortedTests = [...this.testCases]
                        .sort((a, b) => b.time - a.time)
                        .slice(0, 20);

                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Top 20 slowest tests:',
                        sortedTests.length
                    );
                    if (sortedTests.length > 0) {
                        console.log('[TestDetailsPage.initializePerformanceChart] Slowest test:', {
                            name: sortedTests[0].name,
                            time: sortedTests[0].time
                        });
                        console.log('[TestDetailsPage.initializePerformanceChart] Fastest test:', {
                            name: sortedTests[sortedTests.length - 1].name,
                            time: sortedTests[sortedTests.length - 1].time
                        });
                    }

                    const testNames = sortedTests.map(test => test.name.substring(0, 20) + '...');
                    const executionTimes = sortedTests.map(test => test.time);

                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Test names array length:',
                        testNames.length
                    );
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Execution times array length:',
                        executionTimes.length
                    );

                    // Color bars based on performance (execution time) - fast = green, slow = red
                    const maxTime = Math.max(...executionTimes);
                    const minTime = Math.min(...executionTimes);
                    const timeRange = maxTime - minTime || 1;

                    const performanceColors = executionTimes.map(time => {
                        // Calculate color gradient from green (fast) to red (slow)
                        const ratio = (time - minTime) / timeRange;
                        if (ratio < 0.33) return '#10b981'; // Green - fast
                        if (ratio < 0.67) return '#f59e0b'; // Orange - medium
                        return '#ef4444'; // Red - slow
                    });

                    const option = {
                        backgroundColor: 'transparent',
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            },
                            formatter: function (params) {
                                const data = params[0];
                                return `${data.name}<br/>Time: ${data.value.toFixed(3)}s`;
                            },
                            backgroundColor: isDark ? '#374151' : '#ffffff',
                            borderColor: isDark ? '#4b5563' : '#e5e7eb',
                            textStyle: {
                                color: isDark ? '#f3f4f6' : '#1f2937'
                            }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: testNames,
                            axisLabel: {
                                fontSize: 10,
                                rotate: 45,
                                color: isDark ? '#d1d5db' : '#4b5563'
                            },
                            axisLine: {
                                lineStyle: {
                                    color: isDark ? '#4b5563' : '#e5e7eb'
                                }
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'Execution Time (s)',
                            nameTextStyle: {
                                color: isDark ? '#d1d5db' : '#4b5563'
                            },
                            axisLabel: {
                                fontSize: 10,
                                color: isDark ? '#d1d5db' : '#4b5563'
                            },
                            axisLine: {
                                lineStyle: {
                                    color: isDark ? '#4b5563' : '#e5e7eb'
                                }
                            },
                            splitLine: {
                                lineStyle: {
                                    color: isDark ? '#374151' : '#f3f4f6'
                                }
                            }
                        },
                        series: [
                            {
                                type: 'bar',
                                data: executionTimes.map((time, index) => ({
                                    value: time,
                                    itemStyle: {
                                        color: performanceColors[index]
                                    }
                                })),
                                barWidth: '60%'
                            }
                        ]
                    };

                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Setting chart options'
                    );
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Chart option series data length:',
                        option.series[0].data.length
                    );
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Sample data points:',
                        option.series[0].data.slice(0, 3)
                    );

                    this.performanceChart.setOption(option);
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Chart options set successfully'
                    );
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Chart should now be visible with',
                        executionTimes.length,
                        'bars'
                    );

                    // Set up resize handler (only once)
                    if (!this.resizeHandler) {
                        console.log(
                            '[TestDetailsPage.initializePerformanceChart] Setting up resize handler'
                        );
                        this.resizeHandler = () => {
                            if (this.performanceChart) {
                                this.performanceChart.resize();
                            }
                        };
                        window.addEventListener('resize', this.resizeHandler);
                    }

                    // Re-render chart on theme change
                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Setting up theme change listener'
                    );
                    this.setupThemeChangeListener();

                    console.log(
                        '[TestDetailsPage.initializePerformanceChart] Chart initialization complete'
                    );
                }

                setupThemeChangeListener() {
                    // Listen for theme changes via mutation observer
                    if (this.themeObserver) {
                        return; // Already set up
                    }

                    this.themeObserver = new MutationObserver(mutations => {
                        mutations.forEach(mutation => {
                            if (
                                mutation.type === 'attributes' &&
                                mutation.attributeName === 'class'
                            ) {
                                // Theme changed, re-render chart
                                if (this.performanceChart && this.testCases) {
                                    this.initializePerformanceChart();
                                }
                            }
                        });
                    });

                    this.themeObserver.observe(document.documentElement, {
                        attributes: true,
                        attributeFilter: ['class']
                    });
                }

                setupEventListeners() {
                    const statusFilter = document.getElementById('status-filter');
                    const testSearch = document.getElementById('test-search');
                    const suiteFilter = document.getElementById('suite-filter');
                    const toggleAllBtn = document.getElementById('toggle-all-suites');
                    const exportBtn = document.getElementById('export-btn');

                    if (statusFilter) {
                        statusFilter.addEventListener('change', this.filterTestCases.bind(this));
                    }
                    if (testSearch) {
                        testSearch.addEventListener('input', this.filterTestCases.bind(this));
                    }
                    if (suiteFilter) {
                        suiteFilter.addEventListener('change', this.filterTestCases.bind(this));
                    }
                    if (toggleAllBtn) {
                        toggleAllBtn.addEventListener('click', this.toggleAllSuites.bind(this));
                    }
                    if (exportBtn) {
                        exportBtn.addEventListener('click', this.exportResults.bind(this));
                    }
                }

                filterTestCases() {
                    const statusFilter = document.getElementById('status-filter').value;
                    const searchTerm = document.getElementById('test-search').value.toLowerCase();
                    const suiteFilter = document.getElementById('suite-filter').value;

                    console.log('[filterTestCases] Filters:', { statusFilter, searchTerm, suiteFilter });

                    // Get all suite items
                    const suiteItems = document.querySelectorAll('.suite-tree-item');

                    suiteItems.forEach(suiteItem => {
                        const suiteId = suiteItem.dataset.suiteId;

                        // If suite filter is active, hide/show entire suites
                        if (suiteFilter !== 'all') {
                            if (suiteId === suiteFilter) {
                                suiteItem.style.display = '';
                            } else {
                                suiteItem.style.display = 'none';
                                return; // Skip filtering test cases in hidden suites
                            }
                        } else {
                            suiteItem.style.display = '';
                        }

                        // Filter test cases within visible suites
                        const testCaseCards = suiteItem.querySelectorAll('.test-case-card');
                        let visibleTestsCount = 0;

                        testCaseCards.forEach(card => {
                            const testId = card.dataset.testCaseId;
                            const testCase = this.testCases.find(t => t.id === testId);

                            if (!testCase) {
                                card.style.display = 'none';
                                return;
                            }

                            let shouldShow = true;

                            // Apply status filter
                            if (statusFilter !== 'all' && testCase.status !== statusFilter) {
                                shouldShow = false;
                            }

                            // Apply search filter
                            if (searchTerm) {
                                const matchesSearch =
                                    testCase.name.toLowerCase().includes(searchTerm) ||
                                    testCase.classname.toLowerCase().includes(searchTerm);
                                if (!matchesSearch) {
                                    shouldShow = false;
                                }
                            }

                            if (shouldShow) {
                                card.style.display = '';
                                visibleTestsCount++;
                            } else {
                                card.style.display = 'none';
                            }
                        });

                        // Hide suite if no visible test cases
                        if (visibleTestsCount === 0 && (statusFilter !== 'all' || searchTerm)) {
                            suiteItem.style.display = 'none';
                        }
                    });
                }

                toggleSuite(suiteId) {
                    console.log('[TestDetailsPage.toggleSuite] Toggling suite:', suiteId);
                    const content = document.getElementById(`suite-content-${suiteId}`);
                    const arrow = document.getElementById(`suite-arrow-${suiteId}`);

                    if (content && arrow) {
                        const isExpanded = content.classList.contains('expanded');

                        if (isExpanded) {
                            content.classList.remove('expanded');
                            arrow.style.transform = 'rotate(0deg)';
                        } else {
                            content.classList.add('expanded');
                            arrow.style.transform = 'rotate(180deg)';
                        }
                    }
                }

                toggleAllSuites() {
                    const toggleText = document.getElementById('toggle-text');
                    const toggleIcon = document.getElementById('toggle-icon');

                    if (this.allSuitesExpanded) {
                        // Collapse all
                        this.testSuites.forEach(suite => {
                            const content = document.getElementById(`suite-content-${suite.id}`);
                            const arrow = document.getElementById(`suite-arrow-${suite.id}`);

                            if (content && arrow) {
                                content.classList.remove('expanded');
                                arrow.style.transform = 'rotate(0deg)';
                            }
                        });

                        // Update button
                        toggleText.textContent = 'Expand All';
                        toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>';
                        this.allSuitesExpanded = false;
                    } else {
                        // Expand all
                        this.testSuites.forEach(suite => {
                            const content = document.getElementById(`suite-content-${suite.id}`);
                            const arrow = document.getElementById(`suite-arrow-${suite.id}`);

                            if (content && arrow) {
                                content.classList.add('expanded');
                                arrow.style.transform = 'rotate(180deg)';
                            }
                        });

                        // Update button
                        toggleText.textContent = 'Collapse All';
                        toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>';
                        this.allSuitesExpanded = true;
                    }
                }


                async renderFailurePatterns() {
                    const section = document.getElementById('failure-patterns-section');
                    const summaryContainer = document.getElementById('pattern-summary');
                    const patternsContainer = document.getElementById('patterns-container');

                    if (!section || !summaryContainer || !patternsContainer) return;

                    const runId = this.currentRunId;
                    if (!runId) return;

                    try {
                        const analysis = await this.db.getFailurePatterns(runId);

                        if (!analysis || analysis.totalFailures === 0) {
                            section.style.display = 'none';
                            return;
                        }

                        section.style.display = 'block';

                        // Render summary
                        const categories = Object.entries(analysis.categoryCounts);
                        const totalFailures = analysis.totalFailures;

                        summaryContainer.innerHTML = `
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-900">${totalFailures} Test Failure${totalFailures === 1 ? '' : 's'}</h4>
                                    <p class="text-sm text-gray-600">${analysis.patterns.length} distinct pattern${analysis.patterns.length === 1 ? '' : 's'} identified</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-3 mb-4">
                                ${categories
                                    .map(
                                        ([category, count]) => `
                                    <div class="flex items-center space-x-2 px-3 py-2 bg-gray-100 rounded-lg">
                                        <span class="text-sm font-medium text-gray-700">${category}</span>
                                        <span class="text-sm text-gray-600">(${count})</span>
                                    </div>
                                `
                                    )
                                    .join('')}
                            </div>
                        `;

                        // Render patterns
                        patternsContainer.innerHTML = `
                            <div class="space-y-4">
                                ${analysis.patterns
                                    .map(
                                        (pattern, index) => `
                                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                                        <div class="bg-gray-50 px-4 py-3 flex items-center justify-between cursor-pointer" onclick="detailsPage.togglePattern('pattern-${index}')">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-3 mb-2">
                                                    <span class="text-2xl">${this.getCategoryIcon(pattern.category)}</span>
                                                    <div>
                                                        <h5 class="text-base font-semibold text-gray-900">Pattern #${index + 1}: ${pattern.category}</h5>
                                                        <p class="text-sm text-gray-600">${pattern.exceptionType} in ${pattern.rootCause}</p>
                                                    </div>
                                                </div>
                                                <p class="text-sm text-gray-700 ml-9">${this.escapeHtml(pattern.exampleMessage.substring(0, 150))}${pattern.exampleMessage.length > 150 ? '...' : ''}</p>
                                            </div>
                                            <div class="flex items-center space-x-3">
                                                <div class="text-right">
                                                    <span class="text-lg font-bold text-gray-900">${pattern.count}</span>
                                                    <span class="text-sm text-gray-600 block">test${pattern.count === 1 ? '' : 's'}</span>
                                                </div>
                                                <svg id="pattern-arrow-${index}" class="w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </div>
                                        </div>
                                        <div id="pattern-${index}" class="pattern-content hidden px-4 py-4 bg-white">
                                            <div class="mb-4">
                                                <h6 class="text-sm font-semibold text-gray-900 mb-2">Affected Tests (${pattern.affectedTests.length}):</h6>
                                                <div class="space-y-2">
                                                    ${pattern.affectedTests
                                                        .map(
                                                            test => `
                                                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                            <div class="flex-1">
                                                                <p class="text-sm font-medium text-gray-900">${this.escapeHtml(test.name)}</p>
                                                                <p class="text-xs text-gray-600">${this.escapeHtml(test.classname)}</p>
                                                            </div>
                                                            <span class="text-xs text-gray-500">${test.time.toFixed(3)}s</span>
                                                        </div>
                                                    `
                                                        )
                                                        .join('')}
                                                </div>
                                            </div>
                                            ${
                                                pattern.exampleStackTrace
                                                    ? `
                                                <div>
                                                    <h6 class="text-sm font-semibold text-gray-900 mb-2">Example Stack Trace:</h6>
                                                    <pre class="text-xs bg-gray-900 text-gray-100 p-3 rounded overflow-x-auto">${this.escapeHtml(pattern.exampleStackTrace)}</pre>
                                                </div>
                                            `
                                                    : ''
                                            }
                                        </div>
                                    </div>
                                `
                                    )
                                    .join('')}
                            </div>
                        `;
                    } catch (error) {
                        console.error('Failed to load failure patterns:', error);
                        section.style.display = 'none';
                    }
                }

                togglePattern(patternId) {
                    const content = document.getElementById(patternId);
                    const index = patternId.replace('pattern-', '');
                    const arrow = document.getElementById(`pattern-arrow-${index}`);

                    if (content && arrow) {
                        content.classList.toggle('hidden');
                        if (content.classList.contains('hidden')) {
                            arrow.style.transform = 'rotate(0deg)';
                        } else {
                            arrow.style.transform = 'rotate(180deg)';
                        }
                    }
                }

                getCategoryIcon(category) {
                    const icons = {
                        'Assertion Failure': 'üî¥',
                        'Null Pointer Error': '‚ö†Ô∏è',
                        'Timeout Error': '‚è±Ô∏è',
                        'Connection Error': 'üîå',
                        'Setup/Teardown Error': 'üîß',
                        'Invalid State/Argument': '‚ùå',
                        'Other Error': 'üî∂'
                    };
                    return icons[category] || 'üî∂';
                }

                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }

                viewTestDetails(testCaseId) {
                    if (window.testDetailsModal) {
                        window.testDetailsModal.show(testCaseId, this.db);
                    } else {
                        alert('Test details modal not initialized');
                    }
                }

                viewTestHistory(testName, testClass) {
                    // Navigate to test case history page
                    const params = new URLSearchParams({
                        name: testName,
                        classname: testClass
                    });
                    window.location.href = `test-case-history.html?${params.toString()}`;
                }

                exportResults() {
                    // In a real implementation, this would generate and download a report
                    const data = {
                        testRun: this.runId,
                        testSuites: this.testSuites,
                        testCases: this.testCases,
                        exportDate: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], {
                        type: 'application/json'
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `test-results-${this.runId}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                showError(message) {
                    const notification = document.createElement('div');
                    notification.className =
                        'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 bg-red-500 text-white';
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 5000);
                }
            }

            // Initialize details page
            console.log('[details.html] Script loaded, waiting for DOMContentLoaded');
            document.addEventListener('DOMContentLoaded', () => {
                console.log('[details.html] DOMContentLoaded fired, initializing TestDetailsPage');
                console.log('[details.html] Current URL:', window.location.href);
                console.log('[details.html] URL params:', window.location.search);
                window.detailsPage = new TestDetailsPage();
                console.log(
                    '[details.html] TestDetailsPage instance created and assigned to window.detailsPage'
                );
            });
        </script>
    </body>
</html>
