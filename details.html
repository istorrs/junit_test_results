<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="console-capture.js"></script>
        <title>Test Details - JUnit Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class'
            };
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="shared-styles.css" />
        <script src="global-search.js" defer></script>
        <style>
            body {
                font-family: 'Inter', sans-serif;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                min-height: 100vh;
            }

            .code-font {
                font-family: 'JetBrains Mono', monospace;
            }

            .test-case-card {
                transition: all 0.3s ease;
                border-left: 4px solid transparent;
            }

            .test-case-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            }

            .test-case-card.passed {
                border-left-color: #10b981;
            }

            .test-case-card.failed {
                border-left-color: #ef4444;
            }

            .test-case-card.error {
                border-left-color: #f59e0b;
            }

            .test-case-card.skipped {
                border-left-color: #6b7280;
            }

            .stack-trace {
                background: #1a1a1a;
                color: #e5e5e5;
                border-radius: 8px;
                padding: 16px;
                font-family: 'JetBrains Mono', monospace;
                font-size: 14px;
                line-height: 1.5;
                overflow-x: auto;
            }

            .performance-chart {
                backdrop-filter: blur(10px);
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            }

            .nav-link {
                position: relative;
                transition: all 0.3s ease;
            }

            .nav-link:hover {
                color: #3b82f6;
            }

            .nav-link.active::after {
                content: '';
                position: absolute;
                bottom: -2px;
                left: 0;
                right: 0;
                height: 2px;
                background: #3b82f6;
                border-radius: 1px;
            }

            .expandable-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .expandable-content.expanded {
                max-height: 1000px;
            }

            .status-badge {
                display: inline-flex;
                align-items: center;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .status-badge.passed {
                background: #dcfce7;
                color: #166534;
            }

            .status-badge.failed {
                background: #fee2e2;
                color: #991b1b;
            }

            .status-badge.error {
                background: #fef3c7;
                color: #92400e;
            }

            .status-badge.skipped {
                background: #f3f4f6;
                color: #374151;
            }

            .metric-card {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                transition: all 0.3s ease;
            }

            .metric-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }
        </style>
    </head>
    <body>
        <!-- Navigation (populated by navigation.js) -->
        <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40"></nav>

        <!-- Header -->
        <div class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Test Run Details</h1>
                        <p class="text-gray-600 mt-1" id="run-info">
                            Loading test run information...
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button
                            id="export-btn"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200"
                        >
                            Export Results
                        </button>
                        <button
                            onclick="history.back()"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors duration-200"
                        >
                            ‚Üê Back
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                <div class="metric-card rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-gray-900 mb-1" id="total-tests-summary">
                        -
                    </div>
                    <div class="text-sm text-gray-600">Total Tests</div>
                </div>
                <div class="metric-card rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-green-600 mb-1" id="passed-tests-summary">
                        -
                    </div>
                    <div class="text-sm text-gray-600">Passed</div>
                </div>
                <div class="metric-card rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-red-600 mb-1" id="failed-tests-summary">
                        -
                    </div>
                    <div class="text-sm text-gray-600">Failed</div>
                </div>
                <div class="metric-card rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-1" id="total-time-summary">
                        -
                    </div>
                    <div class="text-sm text-gray-600">Total Time</div>
                </div>
            </div>

            <!-- Performance Chart -->
            <div class="performance-chart p-6 mb-8 bg-white/95 dark:bg-gray-800/95">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Test Execution Performance</h3>
                <div id="performance-chart" style="height: 300px"></div>
            </div>

            <!-- Test Suites -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Test Suites</h2>
                    <div class="flex items-center space-x-4">
                        <select
                            id="suite-filter"
                            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="all">All Suites</option>
                        </select>
                        <button
                            id="expand-all"
                            class="text-blue-600 hover:text-blue-800 font-medium"
                        >
                            Expand All
                        </button>
                    </div>
                </div>
                <div id="test-suites-container">
                    <!-- Test suites will be populated here -->
                </div>
            </div>

            <!-- Failure Patterns Analysis -->
            <div
                id="failure-patterns-section"
                class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8"
                style="display: none"
            >
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Failure Patterns</h3>
                </div>
                <div class="p-6">
                    <!-- Pattern Summary -->
                    <div id="pattern-summary" class="mb-6">
                        <!-- Summary will be populated here -->
                    </div>

                    <!-- Patterns List -->
                    <div id="patterns-container">
                        <!-- Patterns will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Test Case List -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Test Cases</h3>
                        <div class="flex items-center space-x-4">
                            <select
                                id="status-filter"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                                <option value="all">All Status</option>
                                <option value="passed">Passed</option>
                                <option value="failed">Failed</option>
                                <option value="error">Error</option>
                                <option value="skipped">Skipped</option>
                            </select>
                            <input
                                type="text"
                                id="test-search"
                                placeholder="Search tests..."
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>
                    </div>
                </div>
                <div id="test-cases-container" class="divide-y divide-gray-200">
                    <!-- Test cases will be populated here -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 mt-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="text-center text-gray-600">
                    <p>
                        &copy; 2025 JUnit Test Results Dashboard. Built with modern web
                        technologies.
                    </p>
                </div>
            </div>
        </footer>

        <!-- Load Scripts -->
        <script src="theme.js"></script>
        <script src="navigation.js"></script>
        <script src="api-client.js"></script>
        <script src="shared-utils.js"></script>
        <script src="test-details-modal.js"></script>
        <script>
            class TestDetailsPage {
                constructor() {
                    console.log('[TestDetailsPage] Constructor started');
                    this.db = new JUnitAPIClient();
                    console.log('[TestDetailsPage] JUnitAPIClient initialized:', this.db);
                    this.runId = null;
                    this.testSuites = [];
                    this.testCases = [];
                    console.log('[TestDetailsPage] Calling init()');
                    this.init();
                }

                async init() {
                    console.log('[TestDetailsPage.init] Starting initialization');
                    try {
                        this.runId = this.getRunIdFromUrl();
                        console.log('[TestDetailsPage.init] Run ID from URL:', this.runId);

                        if (this.runId) {
                            console.log('[TestDetailsPage.init] Loading test run details for ID:', this.runId);
                            await this.loadTestRunDetails();
                            console.log('[TestDetailsPage.init] Test run details loaded successfully');
                        } else {
                            console.warn('[TestDetailsPage.init] No run ID in URL');
                            this.showError('No test run specified');
                        }

                        console.log('[TestDetailsPage.init] Setting up event listeners');
                        this.setupEventListeners();
                        console.log('[TestDetailsPage.init] Initialization complete');
                    } catch (error) {
                        logError('Failed to initialize Test Details page', error);
                        this.showError('Failed to load test details');
                    }
                }

                getRunIdFromUrl() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const runId = urlParams.get('run') || null;
                    console.log('[TestDetailsPage.getRunIdFromUrl] URL search params:', window.location.search);
                    console.log('[TestDetailsPage.getRunIdFromUrl] Extracted run ID:', runId);
                    return runId;
                }

                async loadTestRunDetails() {
                    console.log('[TestDetailsPage.loadTestRunDetails] Starting to load test run details');
                    console.log('[TestDetailsPage.loadTestRunDetails] Run ID:', this.runId);

                    try {
                        console.log('[TestDetailsPage.loadTestRunDetails] Fetching data from API...');
                        const [testRun, testSuites, testCases, statistics] = await Promise.all([
                            this.getTestRun(this.runId),
                            this.db.getTestSuites(this.runId),
                            this.db.getTestCases({ run_id: this.runId }),
                            this.db.getTestStatistics(this.runId)
                        ]);

                        console.log('[TestDetailsPage.loadTestRunDetails] API responses received:');
                        console.log('  - testRun:', testRun);
                        console.log('  - testSuites count:', testSuites?.length || 0);
                        console.log('  - testCases count:', testCases?.length || 0);
                        console.log('  - statistics:', statistics);

                        this.testSuites = testSuites;
                        this.testCases = testCases;

                        console.log('[TestDetailsPage.loadTestRunDetails] Updating UI components...');
                        this.updateRunInfo(testRun);
                        console.log('[TestDetailsPage.loadTestRunDetails] - Run info updated');

                        this.updateSummaryCards(statistics);
                        console.log('[TestDetailsPage.loadTestRunDetails] - Summary cards updated');

                        this.renderTestSuites();
                        console.log('[TestDetailsPage.loadTestRunDetails] - Test suites rendered');

                        this.renderTestCases();
                        console.log('[TestDetailsPage.loadTestRunDetails] - Test cases rendered');

                        this.initializePerformanceChart();
                        console.log('[TestDetailsPage.loadTestRunDetails] - Performance chart initialized');

                        this.renderFailurePatterns();
                        console.log('[TestDetailsPage.loadTestRunDetails] - Failure patterns rendered');

                        console.log('[TestDetailsPage.loadTestRunDetails] All data loaded and rendered successfully');
                    } catch (error) {
                        logError('Failed to load test run details from API', error);
                        throw error;
                    }
                }

                async getTestRun(runId) {
                    console.log('[TestDetailsPage.getTestRun] Fetching test run:', runId);
                    const response = await this.db.getTestRun(runId);
                    console.log('[TestDetailsPage.getTestRun] Response:', response);
                    return response.run;
                }

                updateRunInfo(testRun) {
                    console.log('[TestDetailsPage.updateRunInfo] Updating run info with:', testRun);
                    const runInfoElement = document.getElementById('run-info');
                    console.log('[TestDetailsPage.updateRunInfo] Run info element:', runInfoElement);

                    if (runInfoElement && testRun) {
                        const date = new Date(testRun.timestamp).toLocaleString();
                        const text = `${testRun.name} ‚Ä¢ ${date} ‚Ä¢ ${testRun.total_tests} tests`;
                        runInfoElement.textContent = text;
                        console.log('[TestDetailsPage.updateRunInfo] Set text to:', text);
                    } else {
                        console.warn('[TestDetailsPage.updateRunInfo] Element or data missing');
                    }
                }

                updateSummaryCards(stats) {
                    console.log('[TestDetailsPage.updateSummaryCards] Updating summary cards with:', stats);
                    const elements = {
                        total: document.getElementById('total-tests-summary'),
                        passed: document.getElementById('passed-tests-summary'),
                        failed: document.getElementById('failed-tests-summary'),
                        time: document.getElementById('total-time-summary')
                    };

                    console.log('[TestDetailsPage.updateSummaryCards] Elements found:', {
                        total: !!elements.total,
                        passed: !!elements.passed,
                        failed: !!elements.failed,
                        time: !!elements.time
                    });

                    if (elements.total) {
                        elements.total.textContent = stats.total;
                        console.log('[TestDetailsPage.updateSummaryCards] Total set to:', stats.total);
                    }
                    if (elements.passed) {
                        elements.passed.textContent = stats.passed;
                        console.log('[TestDetailsPage.updateSummaryCards] Passed set to:', stats.passed);
                    }
                    if (elements.failed) {
                        const failedCount = stats.failed + stats.error;
                        elements.failed.textContent = failedCount;
                        console.log('[TestDetailsPage.updateSummaryCards] Failed set to:', failedCount);
                    }
                    if (elements.time) {
                        const timeText = `${stats.total_time.toFixed(2)}s`;
                        elements.time.textContent = timeText;
                        console.log('[TestDetailsPage.updateSummaryCards] Time set to:', timeText);
                    }
                }

                renderTestSuites() {
                    console.log('[TestDetailsPage.renderTestSuites] Starting to render test suites');
                    console.log('[TestDetailsPage.renderTestSuites] Number of suites:', this.testSuites.length);

                    const container = document.getElementById('test-suites-container');
                    const filter = document.getElementById('suite-filter');

                    console.log('[TestDetailsPage.renderTestSuites] Container element:', container);
                    console.log('[TestDetailsPage.renderTestSuites] Filter element:', filter);

                    if (!container) {
                        console.warn('[TestDetailsPage.renderTestSuites] Container not found, aborting');
                        return;
                    }

                    // Populate suite filter
                    if (filter) {
                        console.log('[TestDetailsPage.renderTestSuites] Populating suite filter');
                        filter.innerHTML = '<option value="all">All Suites</option>';
                        this.testSuites.forEach(suite => {
                            const option = document.createElement('option');
                            option.value = suite.id;
                            option.textContent = suite.name;
                            filter.appendChild(option);
                        });
                        console.log('[TestDetailsPage.renderTestSuites] Suite filter populated with', this.testSuites.length, 'options');
                    }

                    console.log('[TestDetailsPage.renderTestSuites] Generating HTML for', this.testSuites.length, 'suites');
                    container.innerHTML = this.testSuites
                        .map(
                            suite => `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                        <div class="px-6 py-4 border-b border-gray-200 cursor-pointer" onclick="detailsPage.toggleSuite('${suite.id}')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-900">${suite.name}</h4>
                                    <p class="text-sm text-gray-600">${suite.tests} tests ‚Ä¢ ${suite.time.toFixed(2)}s</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${suite.failures > 0 ? `<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">${suite.failures} failed</span>` : ''}
                                    ${suite.errors > 0 ? `<span class="px-2 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-800">${suite.errors} errors</span>` : ''}
                                    <svg class="w-5 h-5 text-gray-400 transform transition-transform" id="suite-arrow-${suite.id}">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="expandable-content" id="suite-content-${suite.id}">
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="suite-tests-${suite.id}">
                                    <!-- Test cases will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                `
                        )
                        .join('');
                    console.log('[TestDetailsPage.renderTestSuites] HTML rendered, length:', container.innerHTML.length);
                }

                renderTestCases() {
                    console.log('[TestDetailsPage.renderTestCases] Starting to render test cases');
                    console.log('[TestDetailsPage.renderTestCases] Number of test cases:', this.testCases.length);
                    const container = document.getElementById('test-cases-container');
                    console.log('[TestDetailsPage.renderTestCases] Container element:', container);

                    if (!container) {
                        console.warn('[TestDetailsPage.renderTestCases] Container not found, aborting');
                        return;
                    }

                    container.innerHTML = this.testCases
                        .map(
                            testCase => `
                    <div class="test-case-card ${testCase.status} p-6" data-test-case-id="${testCase.id}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-gray-900 mb-1">${testCase.name}</h4>
                                <p class="text-xs text-gray-600 mb-2">${testCase.classname}</p>
                                <span class="status-badge ${testCase.status}">${testCase.status}</span>
                                ${testCase.is_flaky ? '<span class="status-badge bg-yellow-100 text-yellow-800 ml-2">‚ö†Ô∏è FLAKY</span>' : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-900">${testCase.time.toFixed(3)}s</div>
                                <div class="text-xs text-gray-600">${testCase.assertions} assertions</div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-gray-500">
                                ${testCase.file ? `File: ${testCase.file}` : ''}
                                ${testCase.line ? `Line: ${testCase.line}` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button class="text-green-600 hover:text-green-800 text-xs font-medium" onclick="detailsPage.viewTestHistory('${testCase.name.replace(/'/g, "\\'")}', '${testCase.classname.replace(/'/g, "\\'")}')">
                                    üìä History
                                </button>
                                <button class="text-blue-600 hover:text-blue-800 text-xs font-medium" onclick="detailsPage.viewTestDetails('${testCase.id}')">
                                    Details ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                `
                        )
                        .join('');
                }

                initializePerformanceChart() {
                    const chartContainer = document.getElementById('performance-chart');
                    if (!chartContainer) return;

                    // Get current theme by checking if dark class is present on html element
                    const isDark = document.documentElement.classList.contains('dark');

                    // Dispose existing chart if it exists
                    if (this.performanceChart) {
                        this.performanceChart.dispose();
                    }

                    // Initialize chart with theme-aware colors
                    this.performanceChart = echarts.init(chartContainer);

                    // Prepare data - sort by execution time descending to show slowest tests first
                    const sortedTests = [...this.testCases]
                        .sort((a, b) => b.time - a.time)
                        .slice(0, 20);
                    const testNames = sortedTests.map(test => test.name.substring(0, 20) + '...');
                    const executionTimes = sortedTests.map(test => test.time);

                    // Color bars based on performance (execution time) - fast = green, slow = red
                    const maxTime = Math.max(...executionTimes);
                    const minTime = Math.min(...executionTimes);
                    const timeRange = maxTime - minTime || 1;

                    const performanceColors = executionTimes.map(time => {
                        // Calculate color gradient from green (fast) to red (slow)
                        const ratio = (time - minTime) / timeRange;
                        if (ratio < 0.33) return '#10b981'; // Green - fast
                        if (ratio < 0.67) return '#f59e0b'; // Orange - medium
                        return '#ef4444'; // Red - slow
                    });

                    const option = {
                        backgroundColor: 'transparent',
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            },
                            formatter: function (params) {
                                const data = params[0];
                                return `${data.name}<br/>Time: ${data.value.toFixed(3)}s`;
                            },
                            backgroundColor: isDark ? '#374151' : '#ffffff',
                            borderColor: isDark ? '#4b5563' : '#e5e7eb',
                            textStyle: {
                                color: isDark ? '#f3f4f6' : '#1f2937'
                            }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: testNames,
                            axisLabel: {
                                fontSize: 10,
                                rotate: 45,
                                color: isDark ? '#d1d5db' : '#4b5563'
                            },
                            axisLine: {
                                lineStyle: {
                                    color: isDark ? '#4b5563' : '#e5e7eb'
                                }
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'Execution Time (s)',
                            nameTextStyle: {
                                color: isDark ? '#d1d5db' : '#4b5563'
                            },
                            axisLabel: {
                                fontSize: 10,
                                color: isDark ? '#d1d5db' : '#4b5563'
                            },
                            axisLine: {
                                lineStyle: {
                                    color: isDark ? '#4b5563' : '#e5e7eb'
                                }
                            },
                            splitLine: {
                                lineStyle: {
                                    color: isDark ? '#374151' : '#f3f4f6'
                                }
                            }
                        },
                        series: [
                            {
                                type: 'bar',
                                data: executionTimes.map((time, index) => ({
                                    value: time,
                                    itemStyle: {
                                        color: performanceColors[index]
                                    }
                                })),
                                barWidth: '60%'
                            }
                        ]
                    };

                    this.performanceChart.setOption(option);

                    // Set up resize handler (only once)
                    if (!this.resizeHandler) {
                        this.resizeHandler = () => {
                            if (this.performanceChart) {
                                this.performanceChart.resize();
                            }
                        };
                        window.addEventListener('resize', this.resizeHandler);
                    }

                    // Re-render chart on theme change
                    this.setupThemeChangeListener();
                }

                setupThemeChangeListener() {
                    // Listen for theme changes via mutation observer
                    if (this.themeObserver) {
                        return; // Already set up
                    }

                    this.themeObserver = new MutationObserver(mutations => {
                        mutations.forEach(mutation => {
                            if (
                                mutation.type === 'attributes' &&
                                mutation.attributeName === 'class'
                            ) {
                                // Theme changed, re-render chart
                                if (this.performanceChart && this.testCases) {
                                    this.initializePerformanceChart();
                                }
                            }
                        });
                    });

                    this.themeObserver.observe(document.documentElement, {
                        attributes: true,
                        attributeFilter: ['class']
                    });
                }

                setupEventListeners() {
                    const statusFilter = document.getElementById('status-filter');
                    const testSearch = document.getElementById('test-search');
                    const suiteFilter = document.getElementById('suite-filter');
                    const expandAllBtn = document.getElementById('expand-all');
                    const exportBtn = document.getElementById('export-btn');

                    if (statusFilter) {
                        statusFilter.addEventListener('change', this.filterTestCases.bind(this));
                    }
                    if (testSearch) {
                        testSearch.addEventListener('input', this.filterTestCases.bind(this));
                    }
                    if (suiteFilter) {
                        suiteFilter.addEventListener('change', this.filterTestCases.bind(this));
                    }
                    if (expandAllBtn) {
                        expandAllBtn.addEventListener('click', this.expandAllSuites.bind(this));
                    }
                    if (exportBtn) {
                        exportBtn.addEventListener('click', this.exportResults.bind(this));
                    }
                }

                filterTestCases() {
                    const statusFilter = document.getElementById('status-filter').value;
                    const searchTerm = document.getElementById('test-search').value.toLowerCase();
                    const suiteFilter = document.getElementById('suite-filter').value;

                    let filteredCases = this.testCases;

                    if (statusFilter !== 'all') {
                        filteredCases = filteredCases.filter(test => test.status === statusFilter);
                    }

                    if (searchTerm) {
                        filteredCases = filteredCases.filter(
                            test =>
                                test.name.toLowerCase().includes(searchTerm) ||
                                test.classname.toLowerCase().includes(searchTerm)
                        );
                    }

                    if (suiteFilter !== 'all') {
                        filteredCases = filteredCases.filter(test => test.suite_id === suiteFilter);
                    }

                    this.renderFilteredTestCases(filteredCases);
                }

                renderFilteredTestCases(testCases) {
                    const container = document.getElementById('test-cases-container');
                    if (!container) return;

                    container.innerHTML = testCases
                        .map(
                            testCase => `
                    <div class="test-case-card ${testCase.status} p-6" data-test-case-id="${testCase.id}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-gray-900 mb-1">${testCase.name}</h4>
                                <p class="text-xs text-gray-600 mb-2">${testCase.classname}</p>
                                <span class="status-badge ${testCase.status}">${testCase.status}</span>
                                ${testCase.is_flaky ? '<span class="status-badge bg-yellow-100 text-yellow-800 ml-2">‚ö†Ô∏è FLAKY</span>' : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-900">${testCase.time.toFixed(3)}s</div>
                                <div class="text-xs text-gray-600">${testCase.assertions} assertions</div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-gray-500">
                                ${testCase.file ? `File: ${testCase.file}` : ''}
                                ${testCase.line ? `Line: ${testCase.line}` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button class="text-green-600 hover:text-green-800 text-xs font-medium" onclick="detailsPage.viewTestHistory('${testCase.name.replace(/'/g, "\\'")}', '${testCase.classname.replace(/'/g, "\\'")}')">
                                    üìä History
                                </button>
                                <button class="text-blue-600 hover:text-blue-800 text-xs font-medium" onclick="detailsPage.viewTestDetails('${testCase.id}')">
                                    Details ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                `
                        )
                        .join('');
                }

                toggleSuite(suiteId) {
                    const content = document.getElementById(`suite-content-${suiteId}`);
                    const arrow = document.getElementById(`suite-arrow-${suiteId}`);
                    const testsContainer = document.getElementById(`suite-tests-${suiteId}`);

                    if (content && arrow) {
                        const isExpanded = content.classList.contains('expanded');

                        if (isExpanded) {
                            content.classList.remove('expanded');
                            arrow.style.transform = 'rotate(0deg)';
                        } else {
                            content.classList.add('expanded');
                            arrow.style.transform = 'rotate(180deg)';

                            // Load test cases for this suite
                            if (testsContainer) {
                                const suiteTests = this.testCases.filter(
                                    test => test.suite_id === suiteId
                                );
                                testsContainer.innerHTML = suiteTests
                                    .map(
                                        test => `
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="text-sm font-medium text-gray-900 truncate">${test.name}</h5>
                                        <span class="status-badge ${test.status}">${test.status}</span>
                                    </div>
                                    <div class="text-xs text-gray-600">
                                        Time: ${test.time.toFixed(3)}s
                                    </div>
                                </div>
                            `
                                    )
                                    .join('');
                            }
                        }
                    }
                }

                expandAllSuites() {
                    this.testSuites.forEach(suite => {
                        const content = document.getElementById(`suite-content-${suite.id}`);
                        const arrow = document.getElementById(`suite-arrow-${suite.id}`);

                        if (content && arrow) {
                            content.classList.add('expanded');
                            arrow.style.transform = 'rotate(180deg)';
                        }
                    });
                }

                async renderFailurePatterns() {
                    const section = document.getElementById('failure-patterns-section');
                    const summaryContainer = document.getElementById('pattern-summary');
                    const patternsContainer = document.getElementById('patterns-container');

                    if (!section || !summaryContainer || !patternsContainer) return;

                    const runId = this.currentRunId;
                    if (!runId) return;

                    try {
                        const analysis = await this.db.getFailurePatterns(runId);

                        if (!analysis || analysis.totalFailures === 0) {
                            section.style.display = 'none';
                            return;
                        }

                        section.style.display = 'block';

                        // Render summary
                        const categories = Object.entries(analysis.categoryCounts);
                        const totalFailures = analysis.totalFailures;

                        summaryContainer.innerHTML = `
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-900">${totalFailures} Test Failure${totalFailures === 1 ? '' : 's'}</h4>
                                    <p class="text-sm text-gray-600">${analysis.patterns.length} distinct pattern${analysis.patterns.length === 1 ? '' : 's'} identified</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-3 mb-4">
                                ${categories
                                    .map(
                                        ([category, count]) => `
                                    <div class="flex items-center space-x-2 px-3 py-2 bg-gray-100 rounded-lg">
                                        <span class="text-sm font-medium text-gray-700">${category}</span>
                                        <span class="text-sm text-gray-600">(${count})</span>
                                    </div>
                                `
                                    )
                                    .join('')}
                            </div>
                        `;

                        // Render patterns
                        patternsContainer.innerHTML = `
                            <div class="space-y-4">
                                ${analysis.patterns
                                    .map(
                                        (pattern, index) => `
                                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                                        <div class="bg-gray-50 px-4 py-3 flex items-center justify-between cursor-pointer" onclick="detailsPage.togglePattern('pattern-${index}')">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-3 mb-2">
                                                    <span class="text-2xl">${this.getCategoryIcon(pattern.category)}</span>
                                                    <div>
                                                        <h5 class="text-base font-semibold text-gray-900">Pattern #${index + 1}: ${pattern.category}</h5>
                                                        <p class="text-sm text-gray-600">${pattern.exceptionType} in ${pattern.rootCause}</p>
                                                    </div>
                                                </div>
                                                <p class="text-sm text-gray-700 ml-9">${this.escapeHtml(pattern.exampleMessage.substring(0, 150))}${pattern.exampleMessage.length > 150 ? '...' : ''}</p>
                                            </div>
                                            <div class="flex items-center space-x-3">
                                                <div class="text-right">
                                                    <span class="text-lg font-bold text-gray-900">${pattern.count}</span>
                                                    <span class="text-sm text-gray-600 block">test${pattern.count === 1 ? '' : 's'}</span>
                                                </div>
                                                <svg id="pattern-arrow-${index}" class="w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </div>
                                        </div>
                                        <div id="pattern-${index}" class="pattern-content hidden px-4 py-4 bg-white">
                                            <div class="mb-4">
                                                <h6 class="text-sm font-semibold text-gray-900 mb-2">Affected Tests (${pattern.affectedTests.length}):</h6>
                                                <div class="space-y-2">
                                                    ${pattern.affectedTests
                                                        .map(
                                                            test => `
                                                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                            <div class="flex-1">
                                                                <p class="text-sm font-medium text-gray-900">${this.escapeHtml(test.name)}</p>
                                                                <p class="text-xs text-gray-600">${this.escapeHtml(test.classname)}</p>
                                                            </div>
                                                            <span class="text-xs text-gray-500">${test.time.toFixed(3)}s</span>
                                                        </div>
                                                    `
                                                        )
                                                        .join('')}
                                                </div>
                                            </div>
                                            ${
                                                pattern.exampleStackTrace
                                                    ? `
                                                <div>
                                                    <h6 class="text-sm font-semibold text-gray-900 mb-2">Example Stack Trace:</h6>
                                                    <pre class="text-xs bg-gray-900 text-gray-100 p-3 rounded overflow-x-auto">${this.escapeHtml(pattern.exampleStackTrace)}</pre>
                                                </div>
                                            `
                                                    : ''
                                            }
                                        </div>
                                    </div>
                                `
                                    )
                                    .join('')}
                            </div>
                        `;
                    } catch (error) {
                        console.error('Failed to load failure patterns:', error);
                        section.style.display = 'none';
                    }
                }

                togglePattern(patternId) {
                    const content = document.getElementById(patternId);
                    const index = patternId.replace('pattern-', '');
                    const arrow = document.getElementById(`pattern-arrow-${index}`);

                    if (content && arrow) {
                        content.classList.toggle('hidden');
                        if (content.classList.contains('hidden')) {
                            arrow.style.transform = 'rotate(0deg)';
                        } else {
                            arrow.style.transform = 'rotate(180deg)';
                        }
                    }
                }

                getCategoryIcon(category) {
                    const icons = {
                        'Assertion Failure': 'üî¥',
                        'Null Pointer Error': '‚ö†Ô∏è',
                        'Timeout Error': '‚è±Ô∏è',
                        'Connection Error': 'üîå',
                        'Setup/Teardown Error': 'üîß',
                        'Invalid State/Argument': '‚ùå',
                        'Other Error': 'üî∂'
                    };
                    return icons[category] || 'üî∂';
                }

                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }

                viewTestDetails(testCaseId) {
                    if (window.testDetailsModal) {
                        window.testDetailsModal.show(testCaseId, this.db);
                    } else {
                        alert('Test details modal not initialized');
                    }
                }

                viewTestHistory(testName, testClass) {
                    // Navigate to test case history page
                    const params = new URLSearchParams({
                        name: testName,
                        classname: testClass
                    });
                    window.location.href = `test-case-history.html?${params.toString()}`;
                }

                exportResults() {
                    // In a real implementation, this would generate and download a report
                    const data = {
                        testRun: this.runId,
                        testSuites: this.testSuites,
                        testCases: this.testCases,
                        exportDate: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], {
                        type: 'application/json'
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `test-results-${this.runId}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                showError(message) {
                    const notification = document.createElement('div');
                    notification.className =
                        'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 bg-red-500 text-white';
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 5000);
                }
            }

            // Initialize details page
            console.log('[details.html] Script loaded, waiting for DOMContentLoaded');
            document.addEventListener('DOMContentLoaded', () => {
                console.log('[details.html] DOMContentLoaded fired, initializing TestDetailsPage');
                console.log('[details.html] Current URL:', window.location.href);
                console.log('[details.html] URL params:', window.location.search);
                window.detailsPage = new TestDetailsPage();
                console.log('[details.html] TestDetailsPage instance created and assigned to window.detailsPage');
            });
        </script>
    </body>
</html>
