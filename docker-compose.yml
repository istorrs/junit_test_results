services:
    # MongoDB Database
    mongodb:
        image: mongo:7.0
        container_name: junit-mongodb
        restart: unless-stopped
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme}
            MONGO_INITDB_DATABASE: junit_test_results
            MONGO_APP_USER: ${MONGO_APP_USER:-junit_app}
            MONGO_APP_PASSWORD: ${MONGO_APP_PASSWORD:-changeme}
        volumes:
            - mongodb_data:/data/db
            - ./init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh:ro
        # ports:
        #   - "27017:27017"  # Commented out - MongoDB only accessible within Docker network
        networks:
            - junit-network
        healthcheck:
            test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
            interval: 10s
            timeout: 5s
            retries: 5

    # Backend API Server
    backend:
        build: ./backend
        container_name: junit-backend
        restart: unless-stopped
        environment:
            NODE_ENV: production
            PORT: 5000
            HOST: 0.0.0.0
            MONGODB_URI: mongodb://${MONGO_APP_USER:-junit_app}:${MONGO_APP_PASSWORD:-changeme}@mongodb:27017/junit_test_results?authSource=junit_test_results
            CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost}
            ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost,http://127.0.0.1}
            MAX_FILE_SIZE: ${MAX_FILE_SIZE:-52428800}
            MAX_FILES: ${MAX_FILES:-20}
            LOG_LEVEL: ${LOG_LEVEL:-info}
        ports:
            - '5000:5000'
        volumes:
            - ./backend/uploads:/app/uploads
            - ./backend/logs:/app/logs
        depends_on:
            mongodb:
                condition: service_healthy
        networks:
            - junit-network
        healthcheck:
            test:
                [
                    'CMD',
                    'node',
                    '-e',
                    "require('http').get('http://localhost:5000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"
                ]
            interval: 30s
            timeout: 3s
            retries: 3

    # Nginx Web Server (Frontend + Reverse Proxy)
    nginx:
        image: nginx:alpine
        container_name: junit-nginx
        restart: unless-stopped
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
            # HTML files
            - ./index.html:/usr/share/nginx/html/index.html:ro
            - ./details.html:/usr/share/nginx/html/details.html:ro
            - ./reports.html:/usr/share/nginx/html/reports.html:ro
            - ./test-case-history.html:/usr/share/nginx/html/test-case-history.html:ro
            - ./flaky-tests.html:/usr/share/nginx/html/flaky-tests.html:ro
            - ./data-management.html:/usr/share/nginx/html/data-management.html:ro
            - ./debug-trace.html:/usr/share/nginx/html/debug-trace.html:ro
            - ./debug-console.html:/usr/share/nginx/html/debug-console.html:ro
            # CSS files
            - ./shared-styles.css:/usr/share/nginx/html/shared-styles.css:ro
            # JavaScript files
            - ./api-client.js:/usr/share/nginx/html/api-client.js:ro
            - ./main.js:/usr/share/nginx/html/main.js:ro
            - ./test-details-modal.js:/usr/share/nginx/html/test-details-modal.js:ro
            - ./test-case-history.js:/usr/share/nginx/html/test-case-history.js:ro
            - ./insights.js:/usr/share/nginx/html/insights.js:ro
            - ./debug.js:/usr/share/nginx/html/debug.js:ro
            - ./console-capture.js:/usr/share/nginx/html/console-capture.js:ro
            - ./theme.js:/usr/share/nginx/html/theme.js:ro
            - ./navigation.js:/usr/share/nginx/html/navigation.js:ro
            - ./data-management.js:/usr/share/nginx/html/data-management.js:ro
            - ./debug-console.js:/usr/share/nginx/html/debug-console.js:ro
            # Resources
            - ./resources:/usr/share/nginx/html/resources:ro
            # Add SSL certificates here when ready:
            # - ./ssl/cert.pem:/etc/nginx/ssl/cert.pem:ro
            # - ./ssl/key.pem:/etc/nginx/ssl/key.pem:ro
        depends_on:
            - backend
        networks:
            - junit-network
        healthcheck:
            test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost/health']
            interval: 30s
            timeout: 3s
            retries: 3

volumes:
    mongodb_data:
        driver: local

networks:
    junit-network:
        driver: bridge
